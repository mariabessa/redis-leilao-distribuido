<!DOCTYPE html>
<html>
<head>
  <title>Leil√£o Distribu√≠do</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
      background-image: url(./leilaoImagem.jpg);
      color: #333;
    }
    
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .section {
      margin-bottom: 25px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background-color: white;
    }
    
    .admin {
      border-left: 5px solid #3498db;
    }
    
    .client {
      border-left: 5px solid #2ecc71;
    }
    
    #log {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    
    button {
      padding: 10px 15px;
      margin: 8px 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    button.primary {
      background-color: #3498db;
      color: white;
    }
    
    button.primary:hover {
      background-color: #2980b9;
    }
    
    button.danger {
      background-color: #e74c3c;
      color: white;
    }
    
    button.danger:hover {
      background-color: #c0392b;
    }
    
    button.success {
      background-color: #2ecc71;
      color: white;
    }
    
    button.success:hover {
      background-color: #27ae60;
    }
    
    select, input {
      padding: 10px;
      margin: 8px 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    
    #status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .auction-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .auction-item {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .auction-id {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    
    .bid-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .highlight {
      animation: highlight 2s;
    }
    
    @keyframes highlight {
      0% { background-color: #ffff99; }
      100% { background-color: white; }
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 3px;
    }
    
    .log-info {
      background-color: #e8f4f8;
    }
    
    .log-error {
      background-color: #fde8e8;
      color: #e74c3c;
    }
    
    .log-success {
      background-color: #e8f8f0;
      color: #27ae60;
    }
    
    .log-warning {
      background-color: #fff8e8;
      color: #f39c12;
    }
    
    .top-bids {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    
    .bid-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .bidder-name {
      font-weight: bold;
    }
    
    .bid-amount {
      color: #27ae60;
    }
  </style>
</head>
<body>
  <h1>Leil√£o Distribu√≠do</h1>

  <div class="section admin">
    <h2>Painel de Administra√ß√£o</h2>
    <div class="auction-info" id="auctionInfo"></div>
    
    <div>
      <input type="text" id="adminProductId" placeholder="ID do Produto (ex: prod123)">
      <input type="text" id="item" placeholder="Nome do Item (ex: Pintura Rara)">
      <div style="margin-top: 15px;">
        <button class="success" onclick="iniciarLeilao()">Iniciar Leil√£o</button>
        <button class="danger" onclick="finalizarLeilao()">Finalizar Leil√£o</button>
      </div>
    </div>
  </div>

  <div class="section client">
    <h2>Painel de Lances</h2>
    <select id="auctionSelect" onchange="updateProductId(); fetchEventHistory(this.value)">
      <option value="">Selecione um leil√£o ativo</option>
    </select>
    
    <div class="bid-form">
      <div>
        <input type="text" id="nome" placeholder="Seu nome ou identifica√ß√£o">
      </div>
      <div>
        <input type="number" id="valor" placeholder="Valor do lance (R$)">
      </div>
    </div>
    
    <button class="primary" onclick="enviarLance()">Enviar Lance</button>
  </div>

  <div class="section">
    <h2>Status do Sistema</h2>
    <div id="status" class="log-info">Sistema pronto. Selecione ou inicie um leil√£o.</div>
  </div>

  <div class="section">
    <h2>Registro de Eventos</h2>
    <div id="log"></div>
  </div>

  <script>
    const apiUrl = "http://192.168.49.2:31000"; // Adjust for your environment
    let activeAuctions = [];
    const seenEvents = new Set();

    // Fetch and update list of active auctions
    async function fetchAuctions() {
      try {
        const res = await fetch(`${apiUrl}/leiloes`);
        const data = await res.json();
        activeAuctions = data.auctions || [];
        const select = document.getElementById("auctionSelect");
        const selectedValue = select.value;
        select.innerHTML = '<option value="">Selecione um leil√£o ativo</option>';
        activeAuctions.forEach(auction => {
          const option = document.createElement("option");
          option.value = auction.productId;
          option.text = `${auction.item} (ID: ${auction.productId})`;
          if (auction.productId === selectedValue) {
            option.selected = true;
            updateAuctionInfo(auction);
          }
          select.appendChild(option);
        });
        if (!selectedValue) {
          updateAuctionInfo(null);
        }
      } catch (err) {
        console.error("Erro ao buscar leil√µes:", err);
        updateStatus("Erro ao carregar leil√µes", "log-error");
      }
    }

    // Update auction info display
    function updateAuctionInfo(auction) {
      const auctionInfo = document.getElementById("auctionInfo");
      if (auction) {
        auctionInfo.innerHTML = `
          <div>
            <span class="auction-item">${auction.item}</span>
            <div class="auction-id">ID: ${auction.productId}</div>
          </div>
          <div>
            <div>Lance Atual: R$${auction.lanceAtual || 0}</div>
            <div>Vencedor Atual: ${auction.vencedorAtual || 'Nenhum'}</div>
          </div>
        `;
      } else {
        auctionInfo.innerHTML = '<div>Nenhum leil√£o selecionado</div>';
      }
    }

    // Fetch event history for a productId
    async function fetchEventHistory(productId) {
      if (!productId) {
        const log = document.getElementById("log");
        log.innerHTML = '';
        seenEvents.clear();
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/eventos/historico?productId=${productId}`);
        const events = await res.json();
        const log = document.getElementById("log");
        events.reverse().forEach(event => {
          const eventKey = `${event.tipo}:${event.productId}:${event.mensagem}`;
          if (!seenEvents.has(eventKey)) {
            appendLog(`[Hist√≥rico] ${event.mensagem}`, getLogClass(event.tipo));
            seenEvents.add(eventKey);
          }
        });
        log.scrollTop = log.scrollHeight;
      } catch (err) {
        console.error("Erro ao buscar hist√≥rico:", err);
        appendLog("Erro ao carregar hist√≥rico", "log-error");
      }
    }

    // Append styled log entry
    function appendLog(message, className) {
      const log = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = `log-entry ${className}`;
      entry.textContent = message;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    // Get log class based on event type
    function getLogClass(tipo) {
      switch (tipo) {
        case "inicio":
        case "fim":
          return "log-success";
        case "lance":
          return "log-info";
        case "lance_invalido":
        case "erro":
          return "log-error";
        default:
          return "log-warning";
      }
    }

    // Update status message
    function updateStatus(message, className) {
      const status = document.getElementById("status");
      status.textContent = message;
      status.className = className || "log-info";
    }

    // Update productId input based on selected auction
    function updateProductId() {
      const select = document.getElementById("auctionSelect");
      document.getElementById("adminProductId").value = select.value;
      const selectedAuction = activeAuctions.find(a => a.productId === select.value);
      updateAuctionInfo(selectedAuction);
    }

    // Start auction (admin)
    async function iniciarLeilao() {
      const item = document.getElementById("item").value;
      const productId = document.getElementById("adminProductId").value;
      if (!productId || !item) {
        updateStatus("ID do produto e item s√£o obrigat√≥rios", "log-error");
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/iniciar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ item, productId })
        });
        const data = await res.json();
        updateStatus(data.status || data.erro, data.erro ? "log-error" : "log-success");
        fetchAuctions();
      } catch (err) {
        updateStatus("Erro ao iniciar leil√£o", "log-error");
      }
    }

    // Place bid (client)
    async function enviarLance() {
      const nome = document.getElementById("nome").value;
      const valor = parseInt(document.getElementById("valor").value);
      const productId = document.getElementById("auctionSelect").value;
      if (!productId || !nome || !valor) {
        updateStatus("ID do produto, nome e valor s√£o obrigat√≥rios", "log-error");
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/lance`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, valor, productId })
        });
        const data = await res.json();
        appendLog(`Lance enviado: ${data.status || data.erro}`, data.erro ? "log-error" : "log-success");
      } catch (err) {
        appendLog("Erro ao enviar lance", "log-error");
      }
    }

    // End auction (admin)
    async function finalizarLeilao() {
      const productId = document.getElementById("adminProductId").value;
      if (!productId) {
        updateStatus("ID do produto √© obrigat√≥rio", "log-error");
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/finalizar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId })
        });
        const data = await res.json();
        appendLog(`üèÅ ${data.status}: ${data.vencedor} venceu com R$${data.lance} por ${data.item}`, "log-success");
        fetchAuctions();
      } catch (err) {
        appendLog("Erro ao finalizar leil√£o", "log-error");
      }
    }

    // Listen for real-time updates via SSE
    const eventos = new EventSource(`${apiUrl}/eventos`);
    eventos.onmessage = function(event) {
      const msg = JSON.parse(event.data);
      const eventKey = `${msg.tipo}:${msg.productId}:${msg.mensagem}`;
      if (!seenEvents.has(eventKey)) {
        appendLog(msg.mensagem, getLogClass(msg.tipo));
        seenEvents.add(eventKey);
      }
    };

    // Periodically fetch auctions
    setInterval(fetchAuctions, 10000);
    fetchAuctions();
  </script>
</body>
</html>