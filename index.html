<!DOCTYPE html>
<html>
<head>
  <title>Leil√£o Distribu√≠do</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    .admin { background-color: #e0f7fa; }
    .client { background-color: #e8f5e9; }
    #log { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    button { margin: 5px; }
    select, input { margin: 5px; }
  </style>
</head>
<body>
  <h1>Leil√£o Distribu√≠do</h1>

  <div class="section admin">
    <h2>Admin: Gerenciar Leil√µes</h2>
    <input type="text" id="adminProductId" placeholder="ID do Produto">
    <input type="text" id="item" placeholder="Item do Leil√£o">
    <button onclick="iniciarLeilao()">Iniciar Leil√£o</button>
    <button onclick="finalizarLeilao()">Finalizar Leil√£o</button>
  </div>

  <div class="section client">
    <h2>Cliente: Dar Lances</h2>
    <select id="auctionSelect" onchange="updateProductId(); fetchEventHistory(this.value)">
      <option value="">Selecione um leil√£o</option>
    </select>
    <input type="text" id="nome" placeholder="Seu nome">
    <input type="number" id="valor" placeholder="Seu lance">
    <button onclick="enviarLance()">Dar Lance</button>
  </div>

  <h2>Status</h2>
  <div id="status"></div>

  <h2>Atualiza√ß√µes do Leil√£o</h2>
  <pre id="log"></pre>

  <script>
    const apiUrl = "http://192.168.49.2:31000"; // Adjust for your environment
    let activeAuctions = [];
    const seenEvents = new Set(); // Track unique events to avoid duplicates

    // Fetch and update list of active auctions
    async function fetchAuctions() {
      try {
        const res = await fetch(`${apiUrl}/leiloes`);
        const data = await res.json();
        activeAuctions = data.auctions || [];
        const select = document.getElementById("auctionSelect");
        const selectedValue = select.value;
        select.innerHTML = '<option value="">Selecione um leil√£o</option>';
        activeAuctions.forEach(auction => {
          const option = document.createElement("option");
          option.value = auction.productId;
          option.text = `${auction.item} (ID: ${auction.productId})`;
          if (auction.productId === selectedValue) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Erro ao buscar leil√µes:", err);
      }
    }

    // Fetch event history for a productId
    async function fetchEventHistory(productId) {
      if (!productId) {
        // Clear log only if no auction is selected
        document.getElementById("log").innerText = '';
        seenEvents.clear();
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/eventos/historico?productId=${productId}`);
        const events = await res.json();
        const log = document.getElementById("log");
        // Append only new historical events
        events.reverse().forEach(event => {
          const eventKey = `${event.tipo}:${event.productId}:${event.mensagem}`;
          if (!seenEvents.has(eventKey)) {
            log.innerText += `\n[Hist√≥rico] ${event.mensagem}`;
            seenEvents.add(eventKey);
          }
        });
        // Scroll to bottom
        log.scrollTop = log.scrollHeight;
      } catch (err) {
        console.error("Erro ao buscar hist√≥rico:", err);
      }
    }

    // Update productId input based on selected auction
    function updateProductId() {
      const select = document.getElementById("auctionSelect");
      document.getElementById("adminProductId").value = select.value;
    }

    // Start auction (admin)
    async function iniciarLeilao() {
      const item = document.getElementById("item").value;
      const productId = document.getElementById("adminProductId").value;
      if (!productId || !item) {
        alert('ID do produto e item s√£o obrigat√≥rios');
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/iniciar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ item, productId })
        });
        const data = await res.json();
        document.getElementById("status").innerText = data.status || data.erro;
        fetchAuctions();
      } catch (err) {
        document.getElementById("status").innerText = "Erro ao iniciar leil√£o";
      }
    }

    // Place bid (client)
    async function enviarLance() {
      const nome = document.getElementById("nome").value;
      const valor = parseInt(document.getElementById("valor").value);
      const productId = document.getElementById("auctionSelect").value;
      if (!productId || !nome || !valor) {
        alert('ID do produto, nome e valor s√£o obrigat√≥rios');
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/lance`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, valor, productId })
        });
        const data = await res.json();
        document.getElementById("log").innerText += `\nLance enviado: ${data.status || data.erro}`;
        document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
      } catch (err) {
        document.getElementById("log").innerText += `\nErro ao enviar lance`;
      }
    }

    // End auction (admin)
    async function finalizarLeilao() {
      const productId = document.getElementById("adminProductId").value;
      if (!productId) {
        alert('ID do produto √© obrigat√≥rio');
        return;
      }
      try {
        const res = await fetch(`${apiUrl}/finalizar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId })
        });
        const data = await res.json();
        document.getElementById("log").innerText += `\nüèÅ ${data.status}: ${data.vencedor} venceu com R$${data.lance} por ${data.item}`;
        fetchAuctions();
        document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
      } catch (err) {
        document.getElementById("log").innerText += `\nErro ao finalizar leil√£o`;
      }
    }

    // Listen for real-time updates via SSE
    const eventos = new EventSource(`${apiUrl}/eventos`);
    eventos.onmessage = function(event) {
      const msg = JSON.parse(event.data);
      const log = document.getElementById("log");
      const eventKey = `${msg.tipo}:${msg.productId}:${msg.mensagem}`;
      if (!seenEvents.has(eventKey)) {
        log.innerText += `\n${msg.mensagem}`;
        seenEvents.add(eventKey);
        log.scrollTop = log.scrollHeight;
      }
    };

    // Periodically fetch auctions (less frequent)
    setInterval(fetchAuctions, 10000); // Increased to 10 seconds
    fetchAuctions();
  </script>
</body>
</html>